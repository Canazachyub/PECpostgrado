<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula Virtual - Plataforma Educativa</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- SortableJS para drag and drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <!-- DOMPurify para sanitizacion -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

    <style>
        :root {
            --primary: #E32B2B;
            --primary-dark: #C41E1E;
            --primary-light: #FF4444;
            --secondary: #1B3A57;
            --secondary-dark: #0F2438;
            --secondary-light: #2A5580;
            --accent: #FFC107;
            --accent-dark: #E5AC00;
            --white: #FFFFFF;
            --bg: #F0F2F5;
            --bg-subtle: #E8ECF1;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --green: #059669;
            --green-light: #D1FAE5;
            --border-video: #E32B2B;
            --border-link: #3B82F6;
            --border-texto: #059669;
            --border-pdf: #991B1B;
            --border-imagen: #8B5CF6;
            --border-archivo: #6B7280;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--gray-700);
            background-image: radial-gradient(circle at 1px 1px, rgba(0,0,0,0.03) 1px, transparent 0);
            background-size: 24px 24px;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', sans-serif;
            color: var(--secondary);
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--gray-300); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gray-400); }

        /* ===== ANIMACIONES ===== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-scale-in { animation: scaleIn 0.25s ease-out; }

        /* ===== LOADING SCREEN ===== */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 50%, #0a1929 100%);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(255,255,255,0.15);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .loading-text {
            color: rgba(255,255,255,0.8);
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 1.1rem;
            margin-top: 1.25rem;
            animation: pulse 1.5s ease-in-out infinite;
        }
        .loading-logo {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        /* ===== HEADER ===== */
        .app-header {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            color: var(--white);
            padding: 0 1.5rem;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 40;
            box-shadow: 0 2px 12px rgba(0,0,0,0.2);
        }
        .header-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.15rem;
            color: var(--white);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .header-title i {
            color: var(--accent);
            font-size: 1.3rem;
        }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .header-search {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.15);
            color: var(--white);
            padding: 0.5rem 0.75rem 0.5rem 2.25rem;
            border-radius: 8px;
            font-size: 0.875rem;
            width: 220px;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }
        .header-search::placeholder { color: rgba(255,255,255,0.5); }
        .header-search:focus {
            outline: none;
            background: rgba(255,255,255,0.18);
            border-color: var(--accent);
            width: 280px;
        }
        .search-wrapper {
            position: relative;
        }
        .search-wrapper i {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255,255,255,0.4);
            font-size: 0.8rem;
        }

        .header-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .header-btn:hover {
            background: rgba(255,255,255,0.2);
            color: var(--white);
        }
        .header-btn.active-admin {
            background: var(--accent);
            color: var(--secondary-dark);
            border-color: var(--accent);
        }

        .btn-new-column {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.8rem;
            font-family: 'Montserrat', sans-serif;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.2s;
        }
        .btn-new-column:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(227,43,43,0.3);
        }

        /* ===== ADMIN BADGE ===== */
        .admin-badge {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: var(--secondary-dark);
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            animation: slideDown 0.3s ease-out;
        }

        /* ===== COLUMNAS ===== */
        .columna {
            min-width: 340px;
            max-width: 340px;
            background: var(--white);
            border-radius: 14px;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 88px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 12px rgba(0,0,0,0.04);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid rgba(0,0,0,0.04);
        }
        .columna:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .columna-header {
            padding: 1rem 1.25rem;
            border-radius: 14px 14px 0 0;
            color: var(--white);
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.95rem;
        }
        .columna-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
            min-height: 120px;
        }
        .columna-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
            color: var(--gray-400);
            text-align: center;
        }
        .columna-empty i { font-size: 2rem; margin-bottom: 0.75rem; opacity: 0.5; }
        .columna-empty p { font-size: 0.8rem; }
        .columna-empty .add-card-link {
            color: var(--primary);
            font-weight: 600;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        .columna-empty .add-card-link:hover { color: var(--primary-dark); }

        .col-badge {
            background: rgba(255,255,255,0.2);
            padding: 0.15rem 0.5rem;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .col-add-btn {
            background: rgba(255,255,255,0.15);
            border: none;
            color: var(--white);
            width: 30px;
            height: 30px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            font-size: 0.85rem;
        }
        .col-add-btn:hover { background: rgba(255,255,255,0.3); }

        /* ===== TARJETAS ===== */
        .tarjeta {
            background: var(--white);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.6rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            transition: all 0.2s;
            border: 1px solid var(--gray-200);
            border-left: 4px solid var(--gray-300);
            position: relative;
        }
        .tarjeta.admin-mode { cursor: grab; }
        .tarjeta.admin-mode:active { cursor: grabbing; }
        .tarjeta:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-1px);
        }
        .tarjeta.dragging { opacity: 0.5; }

        .tarjeta[data-tipo="video"] { border-left-color: var(--border-video); }
        .tarjeta[data-tipo="link"] { border-left-color: var(--border-link); }
        .tarjeta[data-tipo="texto"] { border-left-color: var(--border-texto); }
        .tarjeta[data-tipo="pdf"] { border-left-color: var(--border-pdf); }
        .tarjeta[data-tipo="imagen"] { border-left-color: var(--border-imagen); }
        .tarjeta[data-tipo="archivo"] { border-left-color: var(--border-archivo); }

        .tarjeta-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--secondary);
            margin-bottom: 0.35rem;
        }
        .tarjeta-desc {
            color: var(--gray-500);
            font-size: 0.8rem;
            line-height: 1.5;
        }
        .tarjeta-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--gray-100);
        }
        .tarjeta-date {
            font-size: 0.7rem;
            color: var(--gray-400);
        }
        .tarjeta-type-badge {
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-family: 'Montserrat', sans-serif;
        }
        .badge-video { background: #FEE2E2; color: #991B1B; }
        .badge-link { background: #DBEAFE; color: #1E40AF; }
        .badge-texto { background: var(--green-light); color: #065F46; }
        .badge-pdf { background: #FEE2E2; color: #7F1D1D; }
        .badge-imagen { background: #EDE9FE; color: #5B21B6; }
        .badge-archivo { background: var(--gray-100); color: var(--gray-600); }

        .delete-btn {
            color: var(--gray-400);
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 0.8rem;
        }
        .delete-btn:hover {
            color: var(--primary);
            background: #FEE2E2;
        }

        .video-thumbnail-wrapper {
            position: relative;
            cursor: pointer;
            overflow: hidden;
            border-radius: 8px;
            aspect-ratio: 16/9;
            background: var(--gray-100);
        }
        .video-play-button {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 50px; height: 50px;
            background: rgba(227, 43, 43, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .video-thumbnail-wrapper:hover .video-play-button {
            background: var(--primary);
            transform: translate(-50%, -50%) scale(1.1);
        }
        .video-thumbnail-wrapper img { transition: transform 0.3s; }
        .video-thumbnail-wrapper:hover img { transform: scale(1.05); }

        .clickable-card { cursor: pointer; }
        .tarjeta:has(.clickable-card):hover { border-color: var(--primary); }
        .tarjeta img { max-height: 250px; object-fit: cover; }

        /* ===== MODALES ===== */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 36, 56, 0.75);
            z-index: 50;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            backdrop-filter: blur(6px);
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--white);
            border-radius: 16px;
            width: 100%;
            max-width: 640px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            animation: scaleIn 0.25s ease-out;
        }
        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.25rem;
        }
        .modal-body { padding: 1.5rem 2rem; }
        .modal-footer {
            padding: 1rem 2rem 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        .modal-close {
            width: 32px; height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--gray-100);
            color: var(--gray-500);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .modal-close:hover { background: var(--gray-200); color: var(--gray-700); }

        .modal-video { max-width: 90vw; max-height: 90vh; }
        .modal-video .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 8px;
        }
        .modal-video iframe {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            border: 0;
        }

        /* ===== BOTONES ===== */
        .btn-primary {
            background: var(--primary);
            color: var(--white);
            padding: 0.6rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(227,43,43,0.3);
        }
        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            padding: 0.6rem 1.25rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.85rem;
            transition: all 0.2s;
            border: 1px solid var(--gray-200);
            cursor: pointer;
        }
        .btn-secondary:hover { background: var(--gray-200); }

        /* ===== FORMULARIOS ===== */
        .form-input {
            width: 100%;
            padding: 0.7rem 0.85rem;
            border: 1.5px solid var(--gray-200);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
            color: var(--gray-700);
        }
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(227,43,43,0.1);
        }
        .form-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 0.4rem;
            font-family: 'Montserrat', sans-serif;
        }

        /* ===== TABS ===== */
        .tab-button {
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--gray-500);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-family: 'Montserrat', sans-serif;
            background: transparent;
            border-left: none;
            border-right: none;
            border-top: none;
            cursor: pointer;
        }
        .tab-button:hover { color: var(--primary); background: rgba(227,43,43,0.04); }
        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: rgba(227,43,43,0.06);
        }
        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }

        /* ===== DROP ZONE ===== */
        .drop-zone {
            border: 2px dashed var(--gray-300);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s;
            background: var(--gray-50);
        }
        .drop-zone.drag-over {
            border-color: var(--primary);
            background: #FEF2F2;
        }

        /* ===== NOTIFICACIONES ===== */
        .notification {
            position: fixed;
            top: 80px;
            right: 24px;
            padding: 0.85rem 1.25rem;
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 100;
            animation: fadeIn 0.3s ease-out;
            font-weight: 500;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }
        .notification.success {
            background: linear-gradient(135deg, var(--green), #047857);
            color: var(--white);
        }
        .notification.error {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
        }

        /* ===== SPINNER ===== */
        .spinner {
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            animation: spin 0.8s linear infinite;
        }

        /* ===== ADMIN LOGIN MODAL ===== */
        .admin-login-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
        }
        .admin-login-icon i { color: var(--accent); font-size: 1.5rem; }
        .admin-input-wrapper {
            position: relative;
        }
        .admin-input-wrapper i {
            position: absolute;
            left: 0.85rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }
        .admin-input-wrapper input {
            padding-left: 2.5rem;
        }
        .admin-error {
            background: #FEF2F2;
            border: 1px solid #FECACA;
            color: #991B1B;
            padding: 0.6rem 0.85rem;
            border-radius: 8px;
            font-size: 0.8rem;
            margin-top: 0.75rem;
            display: none;
            animation: fadeIn 0.2s ease-out;
        }

        /* ===== OCULTAR ADMIN ===== */
        .admin-only { display: none; }
        body.is-admin .admin-only { display: flex; }
        body.is-admin .admin-only-inline { display: inline-flex; }
        body.is-admin .admin-only-block { display: block; }

        /* ===== PROGRESO ESTUDIANTE ===== */
        .progress-check {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--gray-300);
            background: var(--white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s;
            flex-shrink: 0;
            padding: 0;
            font-size: 0;
            color: transparent;
        }
        .progress-check:hover {
            border-color: var(--green);
            background: var(--green-light);
        }
        .progress-check.done {
            border-color: var(--green);
            background: var(--green);
            color: var(--white);
            font-size: 0.6rem;
            animation: checkPop 0.3s ease-out;
        }
        @keyframes checkPop {
            0% { transform: scale(0.8); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .tarjeta.completed {
            border-left-color: var(--green) !important;
            background: linear-gradient(135deg, #F0FDF4, var(--white));
        }
        .tarjeta.completed .tarjeta-title { color: var(--green); }
        .tarjeta.completed .tarjeta-content { opacity: 0.75; }

        .header-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.35rem 0.75rem;
            border-radius: 8px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .header-progress:hover { background: rgba(255,255,255,0.15); }
        .progress-bar-mini {
            width: 80px;
            height: 6px;
            background: rgba(255,255,255,0.15);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-bar-mini-fill {
            height: 100%;
            background: var(--green);
            border-radius: 3px;
            transition: width 0.5s ease;
            min-width: 0;
        }
        .progress-text-mini {
            color: rgba(255,255,255,0.7);
            font-size: 0.7rem;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            white-space: nowrap;
        }

        .progress-bar-large {
            width: 100%;
            height: 12px;
            background: var(--gray-200);
            border-radius: 6px;
            overflow: hidden;
        }
        .progress-bar-large-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--green), #34D399);
            border-radius: 6px;
            transition: width 0.5s ease;
        }
        .progress-column-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-column-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .columna { min-width: 300px; max-width: 300px; }
            .modal-content { max-width: 95vw; }
            .header-search { width: 140px; }
            .header-search:focus { width: 180px; }
            .modal-video { max-width: 95vw; }
            .modal-video .video-container { padding-bottom: 75%; }
            .app-header { padding: 0 0.75rem; }
            .modal-header, .modal-body, .modal-footer { padding-left: 1.25rem; padding-right: 1.25rem; }
            .progress-bar-mini { width: 50px; }
            .header-progress { padding: 0.3rem 0.5rem; }
        }

        @media (min-width: 1400px) {
            .modal-video { max-width: 1200px; }
        }

        @media (max-aspect-ratio: 16/9) {
            .modal-video .video-container { padding-bottom: 100%; }
        }
    </style>
</head>
<body>
    <!-- ===== LOADING SCREEN ===== -->
    <div id="loadingScreen" class="loading-screen">
        <div class="text-center">
            <div class="loading-logo"><i class="fas fa-graduation-cap"></i></div>
            <div class="loading-spinner mx-auto"></div>
            <p class="loading-text">Cargando Aula Virtual...</p>
        </div>
    </div>

    <!-- ===== HEADER ===== -->
    <header class="app-header">
        <div class="header-title">
            <i class="fas fa-graduation-cap"></i>
            <span id="diplomadoTitle">Aula Virtual</span>
            <span id="adminBadge" class="admin-badge" style="display:none;">ADMIN</span>
        </div>

        <div class="header-actions">
            <div id="headerProgress" class="header-progress" onclick="showProgressModal()" title="Ver mi progreso" style="display:none;">
                <div class="progress-bar-mini">
                    <div id="progressBarMiniFill" class="progress-bar-mini-fill" style="width:0%"></div>
                </div>
                <span id="progressTextMini" class="progress-text-mini">0/0</span>
            </div>

            <div class="search-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Buscar... (Ctrl+K)" class="header-search">
            </div>

            <button onclick="showModal('add-column')" class="btn-new-column admin-only" id="btnNewColumn">
                <i class="fas fa-plus"></i>
                <span class="hidden sm:inline">Columna</span>
            </button>

            <button onclick="showStats()" class="header-btn" title="Estadisticas">
                <i class="fas fa-chart-line"></i>
            </button>

            <button id="btnAdminToggle" onclick="toggleAdminPanel()" class="header-btn" title="Administrador">
                <i class="fas fa-lock"></i>
            </button>

            <a href="inicio.html" class="header-btn" title="Inicio">
                <i class="fas fa-home"></i>
            </a>
        </div>
    </header>

    <!-- ===== CONTENIDO PRINCIPAL ===== -->
    <main>
        <div id="columnasContainer" class="flex gap-5 p-5 overflow-x-auto" style="display:none; min-height: calc(100vh - 64px);">
        </div>
    </main>

    <!-- ===== MODAL: ADMIN LOGIN ===== -->
    <div id="modal-admin-login" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Acceso Administrador</h2>
                <button onclick="closeModal('admin-login')" class="modal-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="admin-login-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <p style="text-align:center; color: var(--gray-500); font-size: 0.85rem; margin-bottom: 1.25rem;">
                    Ingresa la contrasena de administrador para gestionar el contenido del aula virtual.
                </p>
                <form id="formAdminLogin" onsubmit="loginAdmin(event)">
                    <div class="mb-4">
                        <label class="form-label">Contrasena</label>
                        <div class="admin-input-wrapper">
                            <i class="fas fa-key"></i>
                            <input type="password" id="adminPassword" class="form-input" placeholder="Contrasena de administrador" required autocomplete="current-password">
                        </div>
                        <div id="adminLoginError" class="admin-error">
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            <span id="adminLoginErrorText">Contrasena incorrecta</span>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary w-full justify-center" id="btnAdminSubmit">
                        <i class="fas fa-sign-in-alt"></i> Ingresar como Admin
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- ===== MODAL: NUEVA COLUMNA ===== -->
    <div id="modal-add-column" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nueva Columna</h2>
                <button onclick="closeModal('add-column')" class="modal-close"><i class="fas fa-times"></i></button>
            </div>
            <form id="formNuevaColumna" onsubmit="crearColumna(event)">
                <div class="modal-body">
                    <div class="mb-5">
                        <label class="form-label">Titulo de la columna</label>
                        <input type="text" name="titulo" required class="form-input" placeholder="Ej: Recursos principales">
                    </div>
                    <div class="mb-5">
                        <label class="form-label">Color</label>
                        <div class="flex gap-3">
                            <button type="button" onclick="selectColor(this, '#1B3A57')" class="w-10 h-10 rounded-full transition-all hover:scale-110 ring-4 ring-offset-2" style="background:#1B3A57; transform:scale(1.1);"></button>
                            <button type="button" onclick="selectColor(this, '#E32B2B')" class="w-10 h-10 rounded-full transition-all hover:scale-110" style="background:#E32B2B;"></button>
                            <button type="button" onclick="selectColor(this, '#059669')" class="w-10 h-10 rounded-full transition-all hover:scale-110" style="background:#059669;"></button>
                            <button type="button" onclick="selectColor(this, '#7C3AED')" class="w-10 h-10 rounded-full transition-all hover:scale-110" style="background:#7C3AED;"></button>
                            <button type="button" onclick="selectColor(this, '#4B5563')" class="w-10 h-10 rounded-full transition-all hover:scale-110" style="background:#4B5563;"></button>
                        </div>
                        <input type="hidden" name="color" value="#1B3A57">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="closeModal('add-column')" class="btn-secondary">Cancelar</button>
                    <button type="submit" class="btn-primary"><i class="fas fa-check"></i> Crear</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ===== MODAL: NUEVA TARJETA ===== -->
    <div id="modal-add-card" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nueva Tarjeta</h2>
                <button onclick="closeModal('add-card')" class="modal-close"><i class="fas fa-times"></i></button>
            </div>

            <div style="padding: 0 2rem; border-bottom: 1px solid var(--gray-200);">
                <nav class="flex -mb-px">
                    <button onclick="switchTab('texto')" class="tab-button active" data-tab="texto">
                        <i class="fas fa-align-left mr-1"></i>Texto
                    </button>
                    <button onclick="switchTab('link')" class="tab-button" data-tab="link">
                        <i class="fas fa-link mr-1"></i>Enlace
                    </button>
                    <button onclick="switchTab('video')" class="tab-button" data-tab="video">
                        <i class="fas fa-play-circle mr-1"></i>Video
                    </button>
                    <button onclick="switchTab('archivo')" class="tab-button" data-tab="archivo">
                        <i class="fas fa-file-upload mr-1"></i>Archivo
                    </button>
                </nav>
            </div>

            <form id="formNuevaTarjeta" onsubmit="crearTarjeta(event)">
                <input type="hidden" name="columnaId" id="tarjetaColumnaId">
                <input type="hidden" name="tipo" value="texto">

                <div class="modal-body">
                    <!-- Tab Texto -->
                    <div class="tab-content active" data-content="texto">
                        <div class="mb-4">
                            <label class="form-label">Titulo</label>
                            <input type="text" name="titulo_texto" class="form-input" placeholder="Titulo de la tarjeta">
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Contenido</label>
                            <textarea name="contenido_texto" rows="4" class="form-input" placeholder="Escribe el contenido..."></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Descripcion adicional</label>
                            <textarea name="descripcion_texto" rows="2" class="form-input" placeholder="Notas adicionales..."></textarea>
                        </div>
                    </div>

                    <!-- Tab Link -->
                    <div class="tab-content" data-content="link">
                        <div class="mb-4">
                            <label class="form-label">URL del enlace</label>
                            <input type="url" name="url_link" class="form-input" placeholder="https://ejemplo.com" onblur="previewLink(this.value)">
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Titulo del enlace</label>
                            <input type="text" name="titulo_link" class="form-input" placeholder="Titulo descriptivo">
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Descripcion</label>
                            <textarea name="descripcion_link" rows="3" class="form-input" placeholder="Describe el enlace..."></textarea>
                        </div>
                        <div id="linkPreview" class="hidden"></div>
                    </div>

                    <!-- Tab Video -->
                    <div class="tab-content" data-content="video">
                        <div class="mb-4">
                            <label class="form-label">URL del video (YouTube, Vimeo)</label>
                            <input type="url" name="url_video" class="form-input" placeholder="https://youtube.com/watch?v=..." onblur="previewVideo(this.value)">
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Titulo del video</label>
                            <input type="text" name="titulo_video" class="form-input" placeholder="Titulo del video">
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Descripcion</label>
                            <textarea name="descripcion_video" rows="3" class="form-input" placeholder="Describe el video..."></textarea>
                        </div>
                        <div id="videoPreview" class="hidden"></div>
                    </div>

                    <!-- Tab Archivo -->
                    <div class="tab-content" data-content="archivo">
                        <div class="mb-4">
                            <label class="form-label">Archivo</label>
                            <div class="drop-zone" id="dropZone" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                                <i class="fas fa-cloud-upload-alt text-4xl mb-2" style="color: var(--primary);"></i>
                                <p style="color: var(--gray-500); font-size: 0.85rem; margin-bottom: 0.75rem;">Arrastra archivos aqui o</p>
                                <input type="file" id="fileInput" name="archivo" accept=".pdf,.jpg,.jpeg,.png,.gif,.mp4,.webm,.ppt,.pptx,.doc,.docx" onchange="handleFileSelect(event)" class="hidden">
                                <button type="button" onclick="document.getElementById('fileInput').click()" class="btn-primary">
                                    Seleccionar archivo
                                </button>
                            </div>
                            <div id="filePreview" class="hidden mt-3"></div>
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Titulo</label>
                            <input type="text" name="titulo_archivo" class="form-input" placeholder="Titulo descriptivo">
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Descripcion</label>
                            <textarea name="descripcion_archivo" rows="3" class="form-input" placeholder="Describe el archivo..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" onclick="closeModal('add-card')" class="btn-secondary">Cancelar</button>
                    <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Crear Tarjeta</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ===== MODAL: VIDEO PLAYER ===== -->
    <div id="modal-video-player" class="modal">
        <div class="modal-content modal-video">
            <div class="p-4 sm:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="video-modal-title" class="text-lg sm:text-xl font-bold pr-4" style="font-family: 'Montserrat', sans-serif;">
                        Reproduciendo Video
                    </h3>
                    <button onclick="closeVideoModal()" class="modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="video-container" id="video-modal-content"></div>
                <div id="video-modal-description" class="mt-4 p-3 sm:p-4 rounded-lg" style="display:none; background: var(--gray-50);"></div>
            </div>
        </div>
    </div>

    <!-- ===== MODAL: ESTADISTICAS ===== -->
    <div id="modal-stats" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Estadisticas del Aula</h2>
                <button onclick="closeModal('stats')" class="modal-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div id="statsContent" class="space-y-4"></div>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('stats')" class="btn-secondary">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- ===== MODAL: PROGRESO ===== -->
    <div id="modal-progress" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fas fa-tasks" style="color:var(--green); margin-right:0.5rem;"></i>Mi Progreso</h2>
                <button onclick="closeModal('progress')" class="modal-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div id="progressModalContent"></div>
            </div>
            <div class="modal-footer" style="justify-content:space-between;">
                <button onclick="resetProgress()" class="btn-secondary" style="color:var(--primary); font-size:0.8rem;">
                    <i class="fas fa-redo"></i> Reiniciar progreso
                </button>
                <button onclick="closeModal('progress')" class="btn-secondary">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- ===== JAVASCRIPT ===== -->
    <script>
        // ============================================================
        // CONFIGURACION
        // ============================================================
        var API_URL = 'https://script.google.com/macros/s/AKfycbxwzymlbFFt3Eu2xF_yfZtIuXzqoThpHvLh5R0ICTii4GfYD7QmL3ypc3KfMp_4B9pz1g/exec';

        // ============================================================
        // ESTADO DE ADMIN
        // ============================================================
        var isAdmin = false;
        var adminToken = null;
        var ADMIN_SESSION_KEY = 'pec_admin_session';
        var ADMIN_SESSION_DURATION = 24 * 60 * 60 * 1000; // 24 horas

        function checkAdminSession() {
            try {
                var session = localStorage.getItem(ADMIN_SESSION_KEY);
                if (!session) return;
                var parsed = JSON.parse(session);
                if (Date.now() - parsed.timestamp > ADMIN_SESSION_DURATION) {
                    localStorage.removeItem(ADMIN_SESSION_KEY);
                    return;
                }
                isAdmin = true;
                adminToken = parsed.token;
                applyRoleUI();
            } catch(e) {
                localStorage.removeItem(ADMIN_SESSION_KEY);
            }
        }

        function toggleAdminPanel() {
            if (isAdmin) {
                if (confirm('Cerrar sesion de administrador?')) {
                    logoutAdmin();
                }
            } else {
                showModal('admin-login');
                setTimeout(function() {
                    document.getElementById('adminPassword').focus();
                }, 200);
            }
        }

        async function loginAdmin(event) {
            event.preventDefault();
            var password = document.getElementById('adminPassword').value;
            var errorEl = document.getElementById('adminLoginError');
            var errorTextEl = document.getElementById('adminLoginErrorText');
            var submitBtn = document.getElementById('btnAdminSubmit');

            errorEl.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';

            try {
                var response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'verifyAdmin', password: password })
                });
                var text = await response.text();
                var result = JSON.parse(text);

                if (result.success) {
                    isAdmin = true;
                    adminToken = result.adminToken;
                    localStorage.setItem(ADMIN_SESSION_KEY, JSON.stringify({
                        token: adminToken,
                        timestamp: Date.now()
                    }));
                    closeModal('admin-login');
                    document.getElementById('formAdminLogin').reset();
                    applyRoleUI();
                    showNotification('Modo administrador activado', 'success');
                    renderizarColumnas();
                } else {
                    errorTextEl.textContent = result.error || 'Contrasena incorrecta';
                    errorEl.style.display = 'block';
                }
            } catch(e) {
                errorTextEl.textContent = 'Error de conexion. Intenta nuevamente.';
                errorEl.style.display = 'block';
            }

            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Ingresar como Admin';
        }

        function logoutAdmin() {
            isAdmin = false;
            adminToken = null;
            localStorage.removeItem(ADMIN_SESSION_KEY);
            applyRoleUI();
            showNotification('Sesion de administrador cerrada', 'success');
            renderizarColumnas();
        }

        function applyRoleUI() {
            var body = document.body;
            var toggleBtn = document.getElementById('btnAdminToggle');
            var badge = document.getElementById('adminBadge');

            if (isAdmin) {
                body.classList.add('is-admin');
                toggleBtn.classList.add('active-admin');
                toggleBtn.innerHTML = '<i class="fas fa-unlock"></i>';
                toggleBtn.title = 'Cerrar sesion admin';
                badge.style.display = 'inline-block';
            } else {
                body.classList.remove('is-admin');
                toggleBtn.classList.remove('active-admin');
                toggleBtn.innerHTML = '<i class="fas fa-lock"></i>';
                toggleBtn.title = 'Administrador';
                badge.style.display = 'none';
            }
            updateProgressUI();
        }

        // ============================================================
        // API HELPERS
        // ============================================================

        async function apiGet(action, params) {
            params = params || {};
            var url = API_URL + '?action=' + encodeURIComponent(action);
            Object.keys(params).forEach(function(key) {
                if (params[key] !== undefined && params[key] !== null) {
                    url += '&' + encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);
                }
            });
            var response = await fetch(url);
            var text = await response.text();
            return JSON.parse(text);
        }

        async function apiPost(data) {
            // Inyectar adminToken automaticamente
            if (isAdmin && adminToken) {
                data.adminToken = adminToken;
            }
            var response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(data)
            });
            var text = await response.text();
            var result = JSON.parse(text);
            // Si el backend rechaza por token invalido, cerrar sesion
            if (!result.success && result.error && result.error.indexOf('No autorizado') !== -1) {
                logoutAdmin();
                showNotification('Sesion expirada. Inicia sesion nuevamente.', 'error');
            }
            return result;
        }

        // ============================================================
        // VARIABLES GLOBALES
        // ============================================================

        var urlParams = new URLSearchParams(window.location.search);
        var currentDiplomadoId = urlParams.get('diplomado') || '1';
        var diplomadoInfo = { nombre: 'Cargando...', abreviatura: '' };

        var padletData = { columnas: [], tarjetas: {}, config: {} };

        var currentColumnaId = null;
        var selectedFile = null;
        var sortableInstances = [];
        var updateInterval = null;

        // ============================================================
        // PROGRESO DEL ESTUDIANTE
        // ============================================================

        var PROGRESS_KEY = 'pec_progress_' + currentDiplomadoId;
        var studentProgress = {};

        function loadProgress() {
            try {
                var saved = localStorage.getItem(PROGRESS_KEY);
                if (saved) {
                    studentProgress = JSON.parse(saved);
                }
            } catch(e) {
                studentProgress = {};
            }
            updateProgressUI();
        }

        function saveProgress() {
            try {
                localStorage.setItem(PROGRESS_KEY, JSON.stringify(studentProgress));
            } catch(e) {
                console.error('Error guardando progreso:', e);
            }
        }

        function toggleProgress(cardId) {
            if (studentProgress[cardId]) {
                delete studentProgress[cardId];
            } else {
                studentProgress[cardId] = { done: true, at: Date.now() };
            }
            saveProgress();

            // Actualizar UI de la tarjeta
            var tarjetaEl = document.querySelector('.tarjeta[data-id="' + cardId + '"]');
            if (tarjetaEl) {
                var checkBtn = tarjetaEl.querySelector('.progress-check');
                if (studentProgress[cardId]) {
                    tarjetaEl.classList.add('completed');
                    if (checkBtn) {
                        checkBtn.classList.add('done');
                        checkBtn.innerHTML = '<i class="fas fa-check"></i>';
                    }
                } else {
                    tarjetaEl.classList.remove('completed');
                    if (checkBtn) {
                        checkBtn.classList.remove('done');
                        checkBtn.innerHTML = '';
                    }
                }
            }

            updateProgressUI();
        }

        function getProgressStats() {
            var total = 0;
            var completed = 0;
            var byColumn = {};

            padletData.columnas.forEach(function(columna) {
                var tarjetas = padletData.tarjetas[columna.id] || [];
                var colTotal = tarjetas.length;
                var colDone = 0;

                tarjetas.forEach(function(tarjeta) {
                    total++;
                    if (studentProgress[tarjeta.id]) {
                        completed++;
                        colDone++;
                    }
                });

                byColumn[columna.id] = {
                    titulo: columna.titulo,
                    total: colTotal,
                    completed: colDone,
                    percentage: colTotal > 0 ? Math.round((colDone / colTotal) * 100) : 0
                };
            });

            return {
                total: total,
                completed: completed,
                percentage: total > 0 ? Math.round((completed / total) * 100) : 0,
                byColumn: byColumn
            };
        }

        function updateProgressUI() {
            var stats = getProgressStats();
            var headerProgress = document.getElementById('headerProgress');
            var barFill = document.getElementById('progressBarMiniFill');
            var textMini = document.getElementById('progressTextMini');

            if (!headerProgress) return;

            // Ocultar para admin, mostrar para estudiante
            if (isAdmin || stats.total === 0) {
                headerProgress.style.display = 'none';
                return;
            }

            headerProgress.style.display = 'flex';
            barFill.style.width = stats.percentage + '%';
            textMini.textContent = stats.completed + '/' + stats.total;

            // Color progresivo
            if (stats.percentage === 100) {
                barFill.style.background = 'var(--green)';
                textMini.style.color = '#34D399';
            } else if (stats.percentage >= 50) {
                barFill.style.background = 'linear-gradient(90deg, var(--green), #34D399)';
                textMini.style.color = 'rgba(255,255,255,0.9)';
            } else {
                barFill.style.background = 'rgba(255,255,255,0.5)';
                textMini.style.color = 'rgba(255,255,255,0.7)';
            }
        }

        function showProgressModal() {
            var stats = getProgressStats();
            var content = document.getElementById('progressModalContent');

            var html = '';

            // Barra total
            html += '<div style="text-align:center; margin-bottom:1.5rem;">' +
                '<div style="font-size:2.5rem; font-weight:800; color:' + (stats.percentage === 100 ? 'var(--green)' : 'var(--secondary)') + ';">' + stats.percentage + '%</div>' +
                '<p style="font-size:0.85rem; color:var(--gray-500); margin-bottom:0.75rem;">' + stats.completed + ' de ' + stats.total + ' materiales completados</p>' +
                '<div class="progress-bar-large"><div class="progress-bar-large-fill" style="width:' + stats.percentage + '%;"></div></div>' +
            '</div>';

            // Por columna
            if (padletData.columnas.length > 0) {
                html += '<div style="display:flex; flex-direction:column; gap:0.75rem;">';
                padletData.columnas.forEach(function(columna) {
                    var col = stats.byColumn[columna.id];
                    if (!col || col.total === 0) return;
                    var colColor = columna.color || 'var(--secondary)';
                    html += '<div>' +
                        '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem;">' +
                            '<span style="font-size:0.8rem; font-weight:600; color:var(--gray-700);">' + col.titulo + '</span>' +
                            '<span style="font-size:0.75rem; color:var(--gray-500);">' + col.completed + '/' + col.total + '</span>' +
                        '</div>' +
                        '<div class="progress-column-bar"><div class="progress-column-fill" style="width:' + col.percentage + '%; background:' + colColor + ';"></div></div>' +
                    '</div>';
                });
                html += '</div>';
            }

            // Mensaje motivacional
            if (stats.percentage === 100) {
                html += '<div style="text-align:center; margin-top:1.5rem; padding:1rem; background:linear-gradient(135deg,#ECFDF5,#D1FAE5); border-radius:12px;">' +
                    '<i class="fas fa-trophy" style="font-size:2rem; color:var(--accent);"></i>' +
                    '<p style="font-weight:700; color:var(--green); margin-top:0.5rem;">Felicidades! Completaste todo el material</p>' +
                '</div>';
            } else if (stats.percentage >= 50) {
                html += '<div style="text-align:center; margin-top:1rem; font-size:0.8rem; color:var(--gray-500);">' +
                    '<i class="fas fa-fire" style="color:#F59E0B;"></i> Vas muy bien, sigue asi!' +
                '</div>';
            }

            content.innerHTML = html;
            showModal('progress');
        }

        function resetProgress() {
            if (confirm('Reiniciar todo tu progreso? Esta accion no se puede deshacer.')) {
                studentProgress = {};
                saveProgress();
                renderizarColumnas();
                closeModal('progress');
                showNotification('Progreso reiniciado', 'success');
            }
        }

        // ============================================================
        // INICIALIZACION
        // ============================================================

        window.addEventListener('load', async function() {
            checkAdminSession();

            try {
                var infoResponse = await apiGet('getDiplomadoInfo', { diplomado: currentDiplomadoId });
                if (infoResponse.success) {
                    diplomadoInfo = infoResponse.diplomado;
                }
            } catch(e) {
                console.error('Error obteniendo info del diplomado:', e);
            }

            document.getElementById('diplomadoTitle').textContent = diplomadoInfo.nombre || 'Aula Virtual';
            document.title = 'Aula Virtual - ' + (diplomadoInfo.nombre || '');

            cargarDatos();

            updateInterval = setInterval(function() {
                cargarDatosEnSegundoPlano();
            }, 10000);
        });

        // Event delegation para clicks
        document.addEventListener('click', function(e) {
            // Progress checkbox (estudiante)
            if (e.target.closest('.progress-check')) {
                e.preventDefault();
                e.stopPropagation();
                var btn = e.target.closest('.progress-check');
                toggleProgress(btn.dataset.cardId);
                return;
            }

            if (e.target.closest('.delete-btn')) {
                e.preventDefault();
                e.stopPropagation();
                var btn = e.target.closest('.delete-btn');
                eliminarTarjeta(btn.dataset.id);
                return;
            }

            if (e.target.closest('.video-thumbnail-wrapper')) {
                e.preventDefault();
                var wrapper = e.target.closest('.video-thumbnail-wrapper');
                var tarjetaEl = wrapper.closest('.tarjeta');
                var videoUrl = wrapper.dataset.videoUrl || tarjetaEl.dataset.url;
                var titulo = tarjetaEl.dataset.titulo || 'Video';
                var descripcion = tarjetaEl.dataset.descripcion || '';
                var embedUrl = getEmbedUrl(videoUrl);
                if (embedUrl) {
                    openVideoModal(tarjetaEl.dataset.id, embedUrl, titulo, descripcion);
                }
                return;
            }

            var clickableCard = e.target.closest('.clickable-card');
            if (clickableCard && clickableCard.dataset.url) {
                e.preventDefault();
                window.open(clickableCard.dataset.url, '_blank');
                return;
            }
        });

        // ============================================================
        // CARGA DE DATOS
        // ============================================================

        async function cargarDatos() {
            try {
                var response = await apiGet('getAll', { diplomado: currentDiplomadoId });
                onDataLoaded(response);
            } catch (error) {
                onError(error);
            }
        }

        async function cargarDatosEnSegundoPlano() {
            try {
                var response = await apiGet('getAll', { diplomado: currentDiplomadoId });
                if (response.success) {
                    actualizarDatosDiferencial(response);
                }
            } catch (error) { /* silencioso */ }
        }

        function actualizarDatosDiferencial(newData) {
            if (JSON.stringify(newData) !== JSON.stringify(padletData)) {
                padletData = newData;
                renderizarColumnas();
            }
        }

        function onDataLoaded(response) {
            if (response.success) {
                padletData = response;
                loadProgress();
                renderizarColumnas();
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('columnasContainer').style.display = 'flex';
            } else {
                showError('Error cargando datos: ' + (response.error || 'Error desconocido'));
            }
        }

        function onError(error) {
            console.error('Error:', error);
            showError('Error de conexion. Recarga la pagina.');
        }

        // ============================================================
        // RENDERIZADO
        // ============================================================

        function renderizarColumnas() {
            var container = document.getElementById('columnasContainer');
            var scrollPosition = container.scrollLeft;
            container.innerHTML = '';

            sortableInstances.forEach(function(instance) { instance.destroy(); });
            sortableInstances = [];

            padletData.columnas.forEach(function(columna) {
                var columnaEl = crearElementoColumna(columna);
                container.appendChild(columnaEl);

                var tarjetas = padletData.tarjetas[columna.id] || [];
                var tarjetasElements = columnaEl.querySelectorAll('.tarjeta');
                tarjetasElements.forEach(function(tarjetaEl, index) {
                    if (tarjetas[index]) {
                        tarjetaEl.tarjetaData = tarjetas[index];
                    }
                });

                // SortableJS: solo habilitado para admin
                var sortable = new Sortable(columnaEl.querySelector('.columna-content'), {
                    group: 'tarjetas',
                    animation: 150,
                    ghostClass: 'opacity-50',
                    dragClass: 'dragging',
                    disabled: !isAdmin,
                    onEnd: function(evt) {
                        var tarjetaId = evt.item.dataset.id;
                        var fromColumnaId = evt.from.dataset.columnaId;
                        var toColumnaId = evt.to.dataset.columnaId;
                        var newIndex = evt.newIndex;

                        if (fromColumnaId !== toColumnaId || evt.oldIndex !== evt.newIndex) {
                            moverTarjeta(tarjetaId, toColumnaId, newIndex + 1);
                        }
                    }
                });
                sortableInstances.push(sortable);
            });

            container.scrollLeft = scrollPosition;
            updateProgressUI();

            // Reordenar columnas: solo admin
            new Sortable(container, {
                animation: 150,
                handle: '.columna-header',
                disabled: !isAdmin,
                onEnd: function(evt) {
                    var newOrder = Array.from(container.children).map(function(col) {
                        return col.dataset.columnaId;
                    });
                    reordenarColumnas(newOrder);
                }
            });
        }

        function crearElementoColumna(columna) {
            var div = document.createElement('div');
            div.className = 'columna animate-fade-in';
            div.dataset.columnaId = columna.id;

            var tarjetas = padletData.tarjetas[columna.id] || [];
            var headerColor = columna.color || 'var(--secondary)';

            // Boton "+" solo para admin
            var addBtnHTML = isAdmin ?
                '<button onclick="showAddCardModal(\'' + columna.id + '\')" class="col-add-btn"><i class="fas fa-plus"></i></button>' : '';

            var tarjetasHTML = tarjetas.map(function(tarjeta) { return crearElementoTarjeta(tarjeta); }).join('');

            // Estado vacio
            var emptyHTML = '';
            if (tarjetas.length === 0) {
                emptyHTML = '<div class="columna-empty">' +
                    '<i class="fas fa-inbox"></i>' +
                    '<p>Sin contenido aun</p>' +
                    (isAdmin ? '<span class="add-card-link" onclick="showAddCardModal(\'' + columna.id + '\')"><i class="fas fa-plus mr-1"></i>Agregar tarjeta</span>' : '') +
                '</div>';
            }

            div.innerHTML =
                '<div class="columna-header flex justify-between items-center" style="background:' + headerColor + '">' +
                    '<h3 class="font-semibold" style="font-size:0.95rem;">' + columna.titulo + '</h3>' +
                    '<div class="flex items-center gap-2">' +
                        '<span class="col-badge">' + tarjetas.length + '</span>' +
                        addBtnHTML +
                    '</div>' +
                '</div>' +
                '<div class="columna-content" data-columna-id="' + columna.id + '">' +
                    tarjetasHTML +
                    emptyHTML +
                '</div>';

            return div;
        }

        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getTypeBadge(tipo) {
            var labels = { video: 'Video', link: 'Enlace', texto: 'Texto', pdf: 'PDF', imagen: 'Imagen', archivo: 'Archivo' };
            var cls = 'badge-' + (tipo || 'archivo');
            return '<span class="tarjeta-type-badge ' + cls + '">' + (labels[tipo] || tipo || 'Otro') + '</span>';
        }

        function crearElementoTarjeta(tarjeta) {
            var contenidoHTML = '';
            var adminClass = isAdmin ? ' admin-mode' : '';

            switch(tarjeta.tipo) {
                case 'texto':
                    contenidoHTML =
                        '<div class="tarjeta-content">' +
                            '<h4 class="tarjeta-title">' + (tarjeta.titulo || 'Sin titulo') + '</h4>' +
                            '<p class="tarjeta-desc">' + (tarjeta.contenido || '') + '</p>' +
                            (tarjeta.descripcion ? '<p class="tarjeta-desc" style="margin-top:0.5rem; padding-top:0.5rem; border-top:1px solid var(--gray-100);">' + tarjeta.descripcion + '</p>' : '') +
                        '</div>';
                    break;

                case 'link':
                    var hostname = '';
                    try { hostname = new URL(tarjeta.url || 'https://example.com').hostname; } catch(e) { hostname = 'enlace'; }
                    contenidoHTML =
                        '<div class="tarjeta-content clickable-card" data-url="' + (tarjeta.url || '#') + '">' +
                            '<h4 class="tarjeta-title">' + (tarjeta.titulo || 'Enlace') + '</h4>' +
                            (tarjeta.descripcion ? '<p class="tarjeta-desc">' + tarjeta.descripcion + '</p>' : '') +
                            (tarjeta.thumbnailUrl ?
                                '<div style="margin-top:0.5rem; border-radius:6px; overflow:hidden; border:1px solid var(--gray-200);">' +
                                    '<img src="' + tarjeta.thumbnailUrl + '" style="width:100%; height:120px; object-fit:cover;" alt="Preview" onerror="this.parentElement.style.display=\'none\'">' +
                                '</div>' : '') +
                            '<div style="display:flex; align-items:center; gap:0.35rem; color:#3B82F6; margin-top:0.5rem; font-size:0.8rem;">' +
                                '<i class="fas fa-external-link-alt"></i>' +
                                '<span style="text-decoration:underline;">' + hostname + '</span>' +
                            '</div>' +
                        '</div>';
                    break;

                case 'video':
                    contenidoHTML =
                        '<div class="tarjeta-content">' +
                            '<h4 class="tarjeta-title">' + (tarjeta.titulo || 'Video') + '</h4>' +
                            (tarjeta.descripcion ? '<p class="tarjeta-desc" style="margin-bottom:0.5rem;">' + tarjeta.descripcion + '</p>' : '') +
                            '<div class="video-thumbnail-wrapper" data-video-id="' + tarjeta.id + '" data-video-url="' + (tarjeta.url || '') + '">' +
                                (tarjeta.thumbnailUrl ?
                                    '<img src="' + tarjeta.thumbnailUrl + '" style="width:100%; height:100%; object-fit:cover;" alt="' + (tarjeta.titulo || 'Video') + '" onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'flex\';">' : '') +
                                '<div style="display:flex; align-items:center; justify-content:center; width:100%; height:100%; ' + (tarjeta.thumbnailUrl ? 'position:absolute; inset:0; display:none;' : '') + '">' +
                                    '<i class="fas fa-video text-3xl" style="color:var(--gray-400);"></i>' +
                                '</div>' +
                                '<div class="video-play-button">' +
                                    '<i class="fas fa-play text-white" style="margin-left:2px;"></i>' +
                                '</div>' +
                            '</div>' +
                        '</div>';
                    break;

                case 'pdf':
                    contenidoHTML =
                        '<div class="tarjeta-content clickable-card" data-url="' + (tarjeta.url || '#') + '">' +
                            '<div style="display:flex; align-items:start; gap:0.75rem; margin-bottom:0.5rem;">' +
                                '<i class="fas fa-file-pdf text-2xl" style="color:var(--primary); flex-shrink:0;"></i>' +
                                '<div>' +
                                    '<h4 class="tarjeta-title">' + (tarjeta.titulo || 'Documento PDF') + '</h4>' +
                                    (tarjeta.descripcion ? '<p class="tarjeta-desc">' + tarjeta.descripcion + '</p>' : '') +
                                '</div>' +
                            '</div>' +
                            (tarjeta.thumbnailUrl ?
                                '<div style="border-radius:6px; overflow:hidden; border:1px solid var(--gray-200); margin-bottom:0.5rem;">' +
                                    '<img src="' + tarjeta.thumbnailUrl + '" style="width:100%; height:140px; object-fit:cover;" alt="' + (tarjeta.titulo || 'PDF') + '" onerror="this.parentElement.style.display=\'none\'">' +
                                '</div>' : '') +
                            '<div style="text-align:center; font-size:0.8rem; color:var(--primary);"><i class="fas fa-eye mr-1"></i>Ver PDF</div>' +
                        '</div>';
                    break;

                case 'imagen':
                    var imageSrc = tarjeta.thumbnailUrl || tarjeta.url || '';
                    contenidoHTML =
                        '<div class="tarjeta-content clickable-card" data-url="' + (tarjeta.url || '') + '">' +
                            '<h4 class="tarjeta-title">' + (tarjeta.titulo || 'Imagen') + '</h4>' +
                            (tarjeta.descripcion ? '<p class="tarjeta-desc" style="margin-bottom:0.5rem;">' + tarjeta.descripcion + '</p>' : '') +
                            '<img src="' + imageSrc + '" style="width:100%; border-radius:6px;" alt="' + (tarjeta.titulo || '') + '" onerror="this.src=\'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI2UwZTBlMCIvPjwvc3ZnPg==\'">' +
                        '</div>';
                    break;

                default:
                    contenidoHTML =
                        '<div class="tarjeta-content">' +
                            '<div style="display:flex; align-items:start; gap:0.75rem;">' +
                                '<i class="fas fa-file text-xl" style="color:var(--gray-400);"></i>' +
                                '<div>' +
                                    '<h4 class="tarjeta-title">' + (tarjeta.titulo || 'Archivo') + '</h4>' +
                                    '<p class="tarjeta-desc">' + (tarjeta.contenido || '') + '</p>' +
                                    (tarjeta.descripcion ? '<p class="tarjeta-desc" style="margin-top:0.5rem;">' + tarjeta.descripcion + '</p>' : '') +
                                '</div>' +
                            '</div>' +
                        '</div>';
            }

            // Footer: admin ve delete, estudiante ve checkbox + badge
            var isDone = studentProgress[tarjeta.id] ? true : false;
            var completedClass = (!isAdmin && isDone) ? ' completed' : '';

            var footerLeftHTML = '';
            var footerRightHTML = '';

            if (isAdmin) {
                footerLeftHTML = '<span class="tarjeta-date">' + formatDate(tarjeta.fechaCreacion) + '</span>';
                footerRightHTML = '<button class="delete-btn" data-id="' + tarjeta.id + '" onclick="event.stopPropagation();"><i class="fas fa-trash-alt"></i></button>';
            } else {
                footerLeftHTML = '<button class="progress-check' + (isDone ? ' done' : '') + '" data-card-id="' + tarjeta.id + '">' + (isDone ? '<i class="fas fa-check"></i>' : '') + '</button>' +
                    '<span class="tarjeta-date">' + formatDate(tarjeta.fechaCreacion) + '</span>';
                footerRightHTML = getTypeBadge(tarjeta.tipo);
            }

            return '<div class="tarjeta' + adminClass + completedClass + '" data-id="' + tarjeta.id + '" data-tipo="' + tarjeta.tipo + '" data-url="' + (tarjeta.url || '') + '" data-titulo="' + escapeHtml(tarjeta.titulo || '') + '" data-descripcion="' + escapeHtml(tarjeta.descripcion || '') + '">' +
                contenidoHTML +
                '<div class="tarjeta-footer">' +
                    footerLeftHTML +
                    footerRightHTML +
                '</div>' +
            '</div>';
        }

        // ============================================================
        // FUNCIONES DE VIDEO
        // ============================================================

        function openVideoModal(tarjetaId, embedUrl, title, description) {
            var modal = document.getElementById('modal-video-player');
            var titleEl = document.getElementById('video-modal-title');
            var contentEl = document.getElementById('video-modal-content');
            var descriptionEl = document.getElementById('video-modal-description');

            titleEl.textContent = title || 'Reproduciendo Video';

            if (embedUrl && embedUrl !== 'null' && embedUrl !== '') {
                var finalEmbedUrl = embedUrl;
                if (embedUrl.includes('youtube.com')) {
                    var sep = embedUrl.includes('?') ? '&' : '?';
                    finalEmbedUrl = embedUrl + sep + 'autoplay=1&rel=0&modestbranding=1';
                } else if (embedUrl.includes('vimeo.com')) {
                    var sep2 = embedUrl.includes('?') ? '&' : '?';
                    finalEmbedUrl = embedUrl + sep2 + 'autoplay=1&title=0&byline=0&portrait=0';
                }
                contentEl.innerHTML = '<iframe src="' + finalEmbedUrl + '" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" title="' + escapeHtml(title || 'Video') + '" loading="lazy"></iframe>';
            } else {
                contentEl.innerHTML = '<div style="display:flex; align-items:center; justify-content:center; min-height:300px; background:var(--gray-100); border-radius:8px;"><div style="text-align:center;"><i class="fas fa-exclamation-triangle text-4xl" style="color:var(--gray-400);"></i><p style="color:var(--gray-500); margin-top:0.5rem;">No se puede cargar el video</p></div></div>';
            }

            if (description && description !== 'null' && description !== '') {
                descriptionEl.innerHTML = '<h4 style="font-weight:600; margin-bottom:0.5rem; font-size:0.9rem;">Descripcion</h4><p style="color:var(--gray-600); font-size:0.85rem;">' + escapeHtml(description) + '</p>';
                descriptionEl.style.display = 'block';
            } else {
                descriptionEl.style.display = 'none';
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeVideoModal() {
            var modal = document.getElementById('modal-video-player');
            document.getElementById('video-modal-content').innerHTML = '';
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
            var descriptionEl = document.getElementById('video-modal-description');
            if (descriptionEl) { descriptionEl.innerHTML = ''; descriptionEl.style.display = 'none'; }
        }

        function getEmbedUrl(url) {
            if (!url) return null;
            try {
                if (url.includes('youtube.com') || url.includes('youtu.be')) {
                    var videoId = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/);
                    return videoId ? 'https://www.youtube.com/embed/' + videoId[1] : null;
                }
                if (url.includes('vimeo.com')) {
                    var vimeoId = url.match(/vimeo\.com\/(\d+)/);
                    return vimeoId ? 'https://player.vimeo.com/video/' + vimeoId[1] : null;
                }
                if (url.includes('drive.google.com')) {
                    var fileId = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
                    return fileId ? 'https://drive.google.com/file/d/' + fileId[1] + '/preview' : null;
                }
            } catch (error) {
                console.error('Error getting embed URL:', error);
            }
            return null;
        }

        // ============================================================
        // OPERACIONES CRUD
        // ============================================================

        async function crearColumna(event) {
            event.preventDefault();
            var formData = new FormData(event.target);

            showLoading('Creando columna...');
            try {
                await apiPost({
                    action: 'createColumna',
                    columna: { titulo: formData.get('titulo'), color: formData.get('color') },
                    diplomadoId: currentDiplomadoId
                });
                hideLoading();
                closeModal('add-column');
                event.target.reset();
                cargarDatos();
                showNotification('Columna creada', 'success');
            } catch (error) {
                hideLoading();
                onError(error);
            }
        }

        async function crearTarjeta(event) {
            event.preventDefault();
            var formData = new FormData(event.target);
            var tipo = formData.get('tipo');

            var tarjeta = {
                columnaId: formData.get('columnaId'),
                tipo: tipo,
                diplomadoId: currentDiplomadoId
            };

            switch(tipo) {
                case 'texto':
                    tarjeta.titulo = formData.get('titulo_texto');
                    tarjeta.contenido = formData.get('contenido_texto');
                    tarjeta.descripcion = formData.get('descripcion_texto');
                    break;
                case 'link':
                    tarjeta.url = formData.get('url_link');
                    tarjeta.titulo = formData.get('titulo_link') || 'Enlace';
                    tarjeta.descripcion = formData.get('descripcion_link');
                    break;
                case 'video':
                    tarjeta.url = formData.get('url_video');
                    tarjeta.titulo = formData.get('titulo_video') || 'Video';
                    tarjeta.descripcion = formData.get('descripcion_video');
                    break;
                case 'archivo':
                    if (selectedFile) {
                        uploadFile(selectedFile, tarjeta.columnaId, formData.get('titulo_archivo') || selectedFile.name, formData.get('descripcion_archivo'));
                        closeModal('add-card');
                        return;
                    }
                    break;
            }

            showLoading('Creando tarjeta...');
            try {
                await apiPost({
                    action: 'createTarjeta',
                    tarjeta: tarjeta,
                    diplomadoId: currentDiplomadoId
                });
                hideLoading();
                closeModal('add-card');
                event.target.reset();
                cargarDatos();
                showNotification('Tarjeta creada', 'success');
            } catch (error) {
                hideLoading();
                onError(error);
            }
        }

        async function moverTarjeta(tarjetaId, toColumnaId, position) {
            try {
                await apiPost({
                    action: 'moveTarjeta',
                    id: tarjetaId,
                    toColumnaId: toColumnaId,
                    position: position,
                    diplomadoId: currentDiplomadoId
                });
                showNotification('Tarjeta movida', 'success');
            } catch (error) { onError(error); }
        }

        async function eliminarTarjeta(tarjetaId) {
            if (confirm('Confirmas eliminar esta tarjeta?')) {
                try {
                    await apiPost({
                        action: 'deleteTarjeta',
                        id: tarjetaId,
                        diplomadoId: currentDiplomadoId
                    });
                    cargarDatos();
                    showNotification('Tarjeta eliminada', 'success');
                } catch (error) { onError(error); }
            }
        }

        async function reordenarColumnas(newOrder) {
            try {
                await apiPost({
                    action: 'reorderColumnas',
                    order: newOrder,
                    diplomadoId: currentDiplomadoId
                });
                showNotification('Columnas reordenadas', 'success');
            } catch (error) { onError(error); }
        }

        // ============================================================
        // MANEJO DE ARCHIVOS
        // ============================================================

        function handleFileSelect(event) {
            var file = event.target.files[0];
            if (file) { selectedFile = file; showFilePreview(file); }
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('dropZone').classList.remove('drag-over');
            var files = event.dataTransfer.files;
            if (files.length > 0) { selectedFile = files[0]; showFilePreview(files[0]); }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('dropZone').classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('dropZone').classList.remove('drag-over');
        }

        function showFilePreview(file) {
            var preview = document.getElementById('filePreview');
            var fileIcon = getFileIcon(file.type);
            preview.innerHTML =
                '<div style="display:flex; align-items:center; gap:0.75rem; padding:0.75rem; background:var(--gray-50); border-radius:8px; border:1px solid var(--gray-200);">' +
                    '<i class="fas ' + fileIcon + ' text-2xl" style="color:var(--primary);"></i>' +
                    '<div><p style="font-weight:600; font-size:0.85rem;">' + file.name + '</p>' +
                    '<p style="font-size:0.75rem; color:var(--gray-500);">' + (file.size / 1024 / 1024).toFixed(2) + ' MB</p></div>' +
                '</div>';
            preview.classList.remove('hidden');
        }

        function getFileIcon(mimeType) {
            if (mimeType.includes('pdf')) return 'fa-file-pdf';
            if (mimeType.includes('image')) return 'fa-file-image';
            if (mimeType.includes('video')) return 'fa-file-video';
            if (mimeType.includes('presentation')) return 'fa-file-powerpoint';
            if (mimeType.includes('document')) return 'fa-file-word';
            return 'fa-file';
        }

        function uploadFile(file, columnaId, titulo, descripcion) {
            var reader = new FileReader();
            reader.onload = async function(e) {
                var fileData = e.target.result.split(',')[1];
                showLoading('Subiendo archivo...');
                try {
                    await apiPost({
                        action: 'uploadFile',
                        fileData: fileData,
                        fileName: file.name,
                        fileType: file.type,
                        columnaId: columnaId,
                        diplomadoId: currentDiplomadoId,
                        titulo: titulo || file.name,
                        descripcion: descripcion || ''
                    });
                    hideLoading();
                    selectedFile = null;
                    cargarDatos();
                    showNotification('Archivo subido', 'success');
                } catch (error) {
                    hideLoading();
                    onError(error);
                }
            };
            reader.readAsDataURL(file);
        }

        // ============================================================
        // UTILIDADES UI
        // ============================================================

        function showModal(modalId) {
            document.getElementById('modal-' + modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById('modal-' + modalId).classList.remove('active');
            document.body.style.overflow = 'auto';
            var form = document.querySelector('#modal-' + modalId + ' form');
            if (form) form.reset();
            if (modalId === 'admin-login') {
                document.getElementById('adminLoginError').style.display = 'none';
            }
            var linkPreview = document.getElementById('linkPreview');
            var videoPreview = document.getElementById('videoPreview');
            var filePreview = document.getElementById('filePreview');
            if (linkPreview) linkPreview.classList.add('hidden');
            if (videoPreview) videoPreview.classList.add('hidden');
            if (filePreview) filePreview.classList.add('hidden');
            selectedFile = null;
        }

        function showAddCardModal(columnaId) {
            currentColumnaId = columnaId;
            document.getElementById('tarjetaColumnaId').value = columnaId;
            showModal('add-card');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(function(btn) { btn.classList.remove('active'); });
            document.querySelector('[data-tab="' + tabName + '"]').classList.add('active');
            document.querySelectorAll('.tab-content').forEach(function(content) { content.classList.remove('active'); });
            document.querySelector('[data-content="' + tabName + '"]').classList.add('active');
            document.querySelector('input[name="tipo"]').value = tabName;
        }

        function selectColor(button, color) {
            button.parentElement.querySelectorAll('button').forEach(function(btn) {
                btn.classList.remove('ring-4', 'ring-offset-2');
                btn.style.transform = 'scale(1)';
            });
            button.classList.add('ring-4', 'ring-offset-2');
            button.style.transform = 'scale(1.1)';
            document.querySelector('input[name="color"]').value = color;
        }

        function showNotification(message, type) {
            type = type || 'success';
            var notification = document.createElement('div');
            notification.className = 'notification ' + type + ' animate-fade-in';
            notification.innerHTML = '<i class="fas fa-' + (type === 'success' ? 'check-circle' : 'exclamation-circle') + '"></i><span>' + message + '</span>';
            document.body.appendChild(notification);
            setTimeout(function() {
                notification.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(function() { notification.remove(); }, 300);
            }, 3000);
        }

        function showSuccess(message) { showNotification(message, 'success'); }
        function showError(message) { showNotification(message, 'error'); }

        function showLoading(message) {
            message = message || 'Cargando...';
            var loading = document.createElement('div');
            loading.id = 'loadingOverlay';
            loading.style.cssText = 'position:fixed; inset:0; background:rgba(15,36,56,0.5); display:flex; align-items:center; justify-content:center; z-index:60; backdrop-filter:blur(4px);';
            loading.innerHTML = '<div style="background:var(--white); border-radius:14px; padding:1.5rem 2rem; display:flex; align-items:center; gap:1rem; box-shadow:0 25px 50px rgba(0,0,0,0.2);"><div class="spinner"></div><span style="font-weight:500; font-size:0.9rem;">' + message + '</span></div>';
            document.body.appendChild(loading);
        }

        function hideLoading() {
            var loading = document.getElementById('loadingOverlay');
            if (loading) loading.remove();
        }

        // ============================================================
        // FUNCIONES AUXILIARES
        // ============================================================

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                var date = new Date(dateString);
                var now = new Date();
                var diffMs = now - date;
                var diffMins = Math.floor(diffMs / 60000);
                if (diffMins < 1) return 'Ahora';
                if (diffMins < 60) return 'Hace ' + diffMins + 'm';
                var diffHours = Math.floor(diffMins / 60);
                if (diffHours < 24) return 'Hace ' + diffHours + 'h';
                var diffDays = Math.floor(diffHours / 24);
                if (diffDays < 7) return 'Hace ' + diffDays + 'd';
                return date.toLocaleDateString('es-ES');
            } catch (e) { return ''; }
        }

        function previewLink(url) {
            if (!url) return;
            var preview = document.getElementById('linkPreview');
            try {
                var urlObj = new URL(url);
                preview.innerHTML =
                    '<div style="padding:0.75rem; background:var(--gray-50); border-radius:8px; border:1px solid var(--gray-200);">' +
                        '<div style="display:flex; align-items:center; gap:0.5rem; font-size:0.8rem; color:var(--gray-500); margin-bottom:0.5rem;"><i class="fas fa-globe"></i><span>Vista previa</span></div>' +
                        '<div style="display:flex; align-items:center; gap:0.5rem;">' +
                            '<img src="https://www.google.com/s2/favicons?domain=' + urlObj.hostname + '&sz=32" alt="" style="width:20px; height:20px;" onerror="this.style.display=\'none\'">' +
                            '<div><p style="font-weight:600; font-size:0.85rem;">' + urlObj.hostname + '</p><p style="font-size:0.7rem; color:var(--gray-400);">' + url + '</p></div>' +
                        '</div>' +
                    '</div>';
                preview.classList.remove('hidden');
            } catch (e) {
                preview.innerHTML = '<div style="padding:0.75rem; background:#FEF2F2; border-radius:8px; border:1px solid #FECACA;"><p style="font-size:0.8rem; color:#991B1B;">URL invalida</p></div>';
                preview.classList.remove('hidden');
            }
        }

        function previewVideo(url) {
            if (!url) return;
            var embedUrl = getEmbedUrl(url);
            if (embedUrl) {
                var preview = document.getElementById('videoPreview');
                preview.innerHTML = '<div style="border-radius:8px; overflow:hidden; border:1px solid var(--gray-200);"><iframe src="' + embedUrl + '" allowfullscreen style="width:100%; height:220px; border:0;"></iframe></div>';
                preview.classList.remove('hidden');
            }
        }

        async function showStats() {
            showModal('stats');
            try {
                var response = await apiGet('getStats');
                if (response.success) {
                    var stats = response.stats;
                    var content = document.getElementById('statsContent');
                    content.innerHTML =
                        '<div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">' +
                            '<div style="background:linear-gradient(135deg,#EFF6FF,#DBEAFE); padding:1.25rem; border-radius:12px;">' +
                                '<h3 style="font-weight:700; color:#1E3A5F; font-size:0.8rem; margin-bottom:0.5rem;">Columnas</h3>' +
                                '<p style="font-size:1.75rem; font-weight:800; color:#1E40AF;">' + stats.columnas.total + '</p>' +
                                '<p style="font-size:0.75rem; color:#3B82F6;">' + stats.columnas.activas + ' activas</p>' +
                            '</div>' +
                            '<div style="background:linear-gradient(135deg,#ECFDF5,#D1FAE5); padding:1.25rem; border-radius:12px;">' +
                                '<h3 style="font-weight:700; color:#065F46; font-size:0.8rem; margin-bottom:0.5rem;">Tarjetas</h3>' +
                                '<p style="font-size:1.75rem; font-weight:800; color:#059669;">' + stats.tarjetas.total + '</p>' +
                                '<p style="font-size:0.75rem; color:#10B981;">' + (stats.tarjetas.ultimaSemana || 0) + ' esta semana</p>' +
                            '</div>' +
                            '<div style="background:linear-gradient(135deg,#F5F3FF,#EDE9FE); padding:1.25rem; border-radius:12px;">' +
                                '<h3 style="font-weight:700; color:#4C1D95; font-size:0.8rem; margin-bottom:0.5rem;">Archivos</h3>' +
                                '<p style="font-size:1.75rem; font-weight:800; color:#7C3AED;">' + (stats.archivos.fileCount || 0) + '</p>' +
                                '<p style="font-size:0.75rem; color:#8B5CF6;">' + (stats.archivos.totalSizeFormatted || '0 MB') + '</p>' +
                            '</div>' +
                            '<div style="background:linear-gradient(135deg,#FFFBEB,#FEF3C7); padding:1.25rem; border-radius:12px;">' +
                                '<h3 style="font-weight:700; color:#78350F; font-size:0.8rem; margin-bottom:0.5rem;">Actividad</h3>' +
                                '<p style="font-size:1.75rem; font-weight:800; color:#D97706;">' + (stats.tarjetas.ultimoMes || 0) + '</p>' +
                                '<p style="font-size:0.75rem; color:#F59E0B;">Ultimo mes</p>' +
                            '</div>' +
                        '</div>' +
                        '<div style="margin-top:1rem; text-align:center; font-size:0.8rem; color:var(--gray-400);">' +
                            '<p>' + diplomadoInfo.nombre + '</p>' +
                        '</div>';
                }
            } catch (error) { onError(error); }
        }

        // ============================================================
        // BUSQUEDA EN TIEMPO REAL
        // ============================================================

        var searchTimeout;
        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            var query = e.target.value.toLowerCase();
            searchTimeout = setTimeout(function() {
                document.querySelectorAll('.tarjeta').forEach(function(tarjeta) {
                    var content = tarjeta.textContent.toLowerCase();
                    var columna = tarjeta.closest('.columna');
                    var matches = content.includes(query);
                    tarjeta.style.display = matches || !query ? 'block' : 'none';
                    var visibleCards = columna.querySelectorAll('.tarjeta:not([style*="display: none"])').length;
                    columna.style.opacity = visibleCards > 0 || !query ? '1' : '0.5';
                });
            }, 300);
        });

        // ============================================================
        // EVENTOS GLOBALES
        // ============================================================

        // Cerrar modales al clic fuera
        document.querySelectorAll('.modal').forEach(function(modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    var modalId = modal.id.replace('modal-', '');
                    if (modalId === 'video-player') {
                        closeVideoModal();
                    } else {
                        closeModal(modalId);
                    }
                }
            });
        });

        // Atajos de teclado
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(function(modal) {
                    var modalId = modal.id.replace('modal-', '');
                    if (modalId === 'video-player') { closeVideoModal(); } else { closeModal(modalId); }
                });
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
        });

        // Limpiar intervalos al salir
        window.addEventListener('beforeunload', function() {
            if (updateInterval) clearInterval(updateInterval);
        });
    </script>
</body>
</html>
